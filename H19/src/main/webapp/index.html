<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Person CRUD</title>
</head>
<body>

<h1>Persons</h1>

<h2>Add/Update Person</h2>
<form id="personForm">
    <input type="hidden" id="personId">
    <label for="personName">Name:</label>
    <input type="text" id="personName" required>
    <button type="submit">Save</button>
</form>

<h2>All Persons</h2>
<button id="getAllBtn">Get All Persons</button>
<ul id="personList"></ul>

<script>
    const apiUrl = 'api/persons';
    const personForm = document.getElementById('personForm');
    const personIdInput = document.getElementById('personId');
    const personNameInput = document.getElementById('personName');
    const getAllBtn = document.getElementById('getAllBtn');
    const personList = document.getElementById('personList');

    async function getAllPersons() {
        try {
            const response = await fetch(apiUrl);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const persons = await response.json();
            personList.innerHTML = '';
            persons.forEach(person => {
                const li = document.createElement('li');
                li.textContent = `ID: ${person.id}, Name: ${person.name}`;

                const editBtn = document.createElement('button');
                editBtn.textContent = 'Edit';
                editBtn.onclick = () => {
                    personIdInput.value = person.id;
                    personNameInput.value = person.name;
                };

                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = 'Delete';
                deleteBtn.onclick = () => deletePerson(person.id);

                li.appendChild(editBtn);
                li.appendChild(deleteBtn);
                personList.appendChild(li);
            });
        } catch (error) {
            console.error('Error fetching persons:', error);
            alert('Error fetching persons. Check the console for details.');
        }
    }

    async function savePerson(event) {
        event.preventDefault();
        const id = personIdInput.value;
        const name = personNameInput.value;
        const person = { name };

        let url = apiUrl;
        let method = 'POST';

        if (id) {
            person.id = id;
            url = `${apiUrl}/${id}`;
            method = 'PUT';
        }


        try {
            const response = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(person),
            });
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            personForm.reset();
            await getAllPersons();
        } catch (error) {
            console.error('Error saving person:', error);
            alert('Error saving person. Check the console for details.');
        }
    }

    async function deletePerson(id) {
        try {
            const response = await fetch(`${apiUrl}/${id}`, {
                method: 'DELETE',
            });
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            await getAllPersons();
        } catch (error) {
            console.error(`Error deleting person ${id}:`, error);
            alert(`Error deleting person. Check the console for details.`);
        }
    }

    getAllBtn.addEventListener('click', getAllPersons);
    personForm.addEventListener('submit', savePerson);

    getAllPersons();
</script>

</body>
</html>